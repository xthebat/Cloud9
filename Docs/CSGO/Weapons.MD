# Extract and import first-person model view (FOV) weapons of CS:GO

## English version

This guide only if you want to use high-resolution models (FOV)
for third person and thus all animation made in character models.

### 1. Подготовка

- Извлечь VPK-архив CS:GO <!--- TODO: Write MD for VPK archive extraction -->

### 2. Импорт

- Open Blender and go to `File->Import->Plumber->Source Model (.mdl)`
- Select an extracted weapon model (e.g., `v_rif_m4a1_s.mdl/v_rif_ak47.mdl`)
- In the right bar (configuration) change the following parameters:
    * Sets `Scale` to 1.0 (we downscale it later)
    * Disable `Import animations` (because in this case animation used from a character model)
- Wait until the selected map is imported

<!--- TODO: Add english version for weapon import -->

## Russian version

Это руководство предназначено только для использования моделей высокого разрешения (FOV) для третьего лица и,
следовательно, все анимации созданы в моделях персонажей.

[Видео на YouTube с ужасным звуком](https://www.youtube.com/watch?v=5n6vObcgKjw)

### 1. Подготовка

- Извлечь VPK-архив CS:GO <!--- TODO: Write MD for VPK archive extraction -->
- Удалить все объекты, созданные в Blender при старте
- Открыть консольное окно Blender (необязательно, но процесс импорта можно отслеживать)
    * `Окно->Toggle System Console`

### 2. Импорт

- Откройте Blender и перейдите в `File->Import->Plumber->Source Model (.mdl)`
- Выберите извлеченную модель оружия (например, `v_rif_m4a1_s.mdl/v_rif_ak47.mdl`)
- В правой панели (конфигурация) измените следующие параметры:
    * Установите `Scale` на 1.0 (мы уменьшим его позже)
    * Отключите `Import animations` (потому что в этом случае анимация используется из модели персонажа)
- Дождитесь завершения импорта выбранной модели

### 3. Blender postprocess

- **ЗАМЕЧАНИЕ**: Структура модели может различаться в зависимости от самой модели. Например, у модели AK47 отсутствует
  разделение на объекты: модель базовой части оружия, магазина, затвора и т.п. Это сделано с помощью `Vertex Groups`. У
  M4A1-S такое разделение частично есть, а частично также с помощью `Vertex Groups`.
- **ПРИМЕЧАНИЕ**: То что написано дальше очень неочевидно (для тех кто не работает с Blender) и потребуется для
  редактирования модели. Blender находясь в режиме `Modeling` может быть в режиме редактирования Vertex'ов
  или `Object Mode`. После нажатия на кнопку `Modeling` Blender будет в режиме редактирования Vertex'ов. Чтобы перейти
  в `Object Mode` в правой меню Blender'а (где нарисована структура объекта), необходимо
  выключить `Change the object in the current mode` (выглядит как квадрат с жирными точками в углах). Это необходимо для
  объединения подмоделей (см. далее)... либо я ничего не понимаю как работать в этом редакторе. Режим редактирования
  Vertex'ов необходим для разделения модели на подмодели. Также находясь в режиме редактирования Vertex'ов можно
  выбирать какая подмодель сейчас редактируется. Для этого необходимо нажать не на квадрат возле подмодели, а на кружок
  возле другой подмодели (после этого активной станет подмодель на кружок которой нажали).

- Удалить данные об анимации/позе (элемент модели с зеленой иконкой) - она не понадобится.
- Установить точку привязки модели:
    - Выбрать все "подмодели" (оранжевые перевернутые треугольники) с помощью CTRL
    - Выравнять выбранные элементы так, чтобы **рукоятка модели** была в нулевой координате (по этой точке будет
      делаться привязка к руке персонажа).
    - **ПРИМЕЧАНИЕ**: Чтобы вращать и перемещать модель необходимо выбрать нужный инструмент
      на левой панельке Blender'а (перемещение/поворот).
    - **ВНИМАНИЕ**: модель может быть смещена по всем осям, а также у модели может быть поворот.
- Удалить все лишние "подмодели" (с оранжевыми иконками). Это могут пустые объекты или внутренняя часть,
  которая будет в любом случае не видна.
- Удалить `Modifiers/Armature` в каждой подмодели - они не нужны для дальнейшей работы в случае использования модели для
  третьего лица. Для этого необходимо нажать на нужно подмодель, выбрать `Modifier` (синяя иконка). После этого в правой
  части панели управления Blender'а (ниже иерархии) необходимо также выбрать `Modifier` (синяя иконка с гаечным ключом),
  далее в списки `Modifier` нажать справка крестик для его удаления.
- Объединить подмодели, которые не должны быть разделены. То есть при импорте в Blender могут быть созданы две
  подмодели, которые не требуется импортировать Unreal Engine как две раздельные. Для этого необходимо находится в
  `Object Mode` Blender'а и выбрать необходимые подмодели с помощью CTRL. После этого нажать сочетание клавиш `CTRL+J`.
- Разделить модель с помощью по `Vertex Group`ам (обычно магазин сшит с основной моделью в одну).
    - Перейти в раздел `Modeling` в верхней части Blender'а.
    - Раскрыть необходимую модель в иерархии объектов.
    - В нижней части правой панельки Blender'а выбрать `Data` (зеленый треугольник направленный вниз).
    - В появившемся окне выбрать нужную `Vertex Group`у, например `v_weapon.M4A1_Clip` и ниже нажать кнопку `Select`.
    - В меню под выбором режимов (`Layout`, `Modeling`...), необходимо выбрать `Mesh->Separate-Selection` (или нажать
      кнопку `P`). После этого в иерархии должна появиться новая подмодель.
- Переименовать подмодели в иерархии объектов.
- Удалить не нужные `Vertex Group`ы:
    - Для этого необходимо в иерархии объектов выбрать нужную подмодель нажав на точку возле неё (необходимо находиться
      в режиме `Modeling`).
    - В нижней части правой панельки Blender'а в разделе `Data` появятся `Vertex Group`у их можно удалить с помощью
      кнопки `-` рядом.
- Перейти в `Object Mode` и перенести все подмодели в нулевую координату. Это необходимо, что точки привязки после
  импорта в Unreal Engine у всех моделей была в нуле (модель в Blender'е при этом станет не корректной).
- Сохранить модель в blend-файл.
- Извлечь ресурсы текстур модели из blend-файла [делается по аналогии с картами, п.3](Maps.MD)

- **ВНИМАНИЕ: МАСШТАБ МОДЕЛИ ДЛЯ 1-ГО ЛИЦА МОЖЕТ ОТЛИЧАТЬСЯ ОТ МАСШТАБА МОДЕЛИ ДЛЯ 3-ГО ЛИЦА**
    - Для deagle отличие составляло около 1.276 раза (модель 3-го лица должна быть больше на этот коэффициент)
    - Для awp отличие составляет 1.08895 раза
    - Для ak47 и m4a1s выглядит так что отличия нет

**4. Blender export to fbx**

- Выбраться `File->Export->FBX`
- Задать следующие настройки (могут отличаться в зависимости от задачи, здесь указаны принятые в проекте):
    - Scale: **0.02**
    - Apply Scaling: All locals
    - Forward: **X Forward**
    - Up: **Z Up**
    - Apply unit: yes
    - Use space transform: **NO**
    - Apply transform: **NO**
    - Bake Animation: NO

**4. Import into UE4 and postprocess**

- Импортировать fbx-модель в Unreal Engine путем перетаскивания в редактор